<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Schemes - YojanaMitra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>

<body class="bg-light">

    <!-- Navigation (Simplified) -->
    <nav class="navbar navbar-expand-lg sticky-top border-bottom border-secondary border-opacity-10"
        style="backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.9);">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                <i class="fas fa-handshake" style="color: #2563eb; font-size: 1.8rem; margin-right: 0.5rem;"></i>
                <span
                    style="color: #0f172a; font-size: 1.3rem; font-weight: 700; background: transparent !important;">Yojana
                    Mitra</span>
            </a>
            <div class="d-flex align-items-center gap-3 ms-auto">
                <button class="btn btn-sm text-secondary border-0" onclick="toggleLanguage()">
                    <i class="fas fa-globe me-1"></i> <span id="lang-btn-text">English</span>
                </button>
                <a href="/" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-home me-2"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-1">
                    All Government Schemes
                    <span id="schemes-count"
                        class="badge bg-primary bg-opacity-10 text-primary fs-6 align-middle ms-2 fw-medium"
                        style="font-size: 0.9rem !important;">Loading...</span>
                </h2>
                <p class="text-muted">Browse and filter through our comprehensive database of schemes.</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4 border-0 shadow-sm" style="border-radius: 15px;">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label small fw-bold text-secondary">Search</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fas fa-search text-muted"></i></span>
                            <input type="text" id="search-input" class="form-control border-start-0 ps-0 bg-white"
                                style="background-color: #fff !important;" placeholder="Search by name, benefits...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-secondary">Category</label>
                        <select id="category-filter" class="form-select bg-white"
                            style="background-color: #fff !important;">
                            <option value="">All Categories</option>
                            <option value="Agriculture">Agriculture</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Education">Education</option>
                            <option value="Housing">Housing</option>
                            <option value="Social Welfare">Social Welfare</option>
                            <option value="Employment">Employment</option>
                            <option value="Financial Inclusion">Financial Inclusion</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-secondary">State</label>
                        <select id="state-filter" class="form-select bg-white"
                            style="background-color: #fff !important;">
                            <option value="">All States</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadSchemes()">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schemes Grid -->
        <div id="schemes-list" class="row g-4">
            <!-- Loaded via JS -->
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        async function loadSchemes() {
            const query = document.getElementById('search-input').value;
            const category = document.getElementById('category-filter').value;
            const state = document.getElementById('state-filter').value;

            const params = new URLSearchParams({ q: query, category: category, state: state });
            const target = document.getElementById('schemes-list');
            target.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const res = await fetch(`/api/schemes?${params}`);
                const data = await res.json();

                // Update Count
                const countBadge = document.getElementById('schemes-count');
                if (countBadge) countBadge.textContent = `${data.schemes.length} Schemes`;

                target.innerHTML = '';
                if (data.schemes.length === 0) {
                    target.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3 opacity-50"></i>
                            <h5 class="text-muted">No schemes found matching your criteria.</h5>
                            <p class="text-muted small">Try adjusting your filters or search terms.</p>
                        </div>
                    `;
                    return;
                }

                data.schemes.forEach(scheme => {
                    // Truncate description
                    const desc = scheme.description.length > 100 ? scheme.description.substring(0, 100) + '...' : scheme.description;

                    const card = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-0 shadow-sm scheme-card-hover" style="border-radius: 12px; transition: transform 0.2s;">
                            <div class="card-body d-flex flex-column p-4">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 rounded-pill px-3 py-2">
                                        ${scheme.category || 'General'}
                                    </span>
                                </div>
                                <h5 class="card-title fw-bold mb-3" style="color: #1e293b; min-height: 48px;">${scheme.name}</h5>
                                <p class="card-text text-muted small mb-4 flex-grow-1" style="line-height: 1.6;">${desc}</p>
                                
                                <div class="mt-auto pt-3 border-top border-light">
                                    <p class="small text-secondary mb-3">
                                        <i class="fas fa-gift me-2 text-warning"></i> 
                                        <strong>Benefits:</strong> ${scheme.benefits ? scheme.benefits.substring(0, 50) + (scheme.benefits.length > 50 ? '...' : '') : 'N/A'}
                                    </p>
                                    <button onclick="showSchemeDetails(${scheme.id})" class="btn btn-outline-primary w-100 rounded-pill fw-medium">
                                        View Details <i class="fas fa-info-circle ms-2 small"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    target.innerHTML += card;
                });

                // Re-apply translations to new elements
                if (typeof updateLanguage === 'function') {
                    updateLanguage();
                }
            } catch (e) {
                console.error(e);
                target.innerHTML = '<div class="col-12 text-danger text-center">Failed to load schemes. Please try again later.</div>';
            }
        }

        // Helper to format text as list items
        function formatDetailList(text, targetId) {
            const container = document.getElementById(targetId);
            if (!text || text.toLowerCase() === 'none' || text === 'null') {
                container.innerHTML = '<li>Details to be checked on official portal.</li>';
                return false;
            }

            let cleaned = text.trim();
            const lines = [];
            const rawLines = cleaned.split(/\n/);
            let currentLine = "";
            const isMarker = (str) => /^(?:•|\*|-|\d+\.)/.test(str.trim());

            rawLines.forEach((line) => {
                const trimmed = line.trim();
                if (!trimmed) return;

                if (isMarker(trimmed) || currentLine === "") {
                    if (currentLine) lines.push(currentLine);
                    currentLine = trimmed.replace(/^(?:•|\*|-|\d+\.)\s*/, "");
                } else {
                    currentLine += " " + trimmed;
                }
            });
            if (currentLine) lines.push(currentLine);

            if (lines.length === 0) {
                container.innerHTML = `<li>${cleaned}</li>`;
                return true;
            }

            container.innerHTML = lines.map(line => `<li>${line}</li>`).join('');
            return true;
        }

        // Show Scheme Details Modal
        async function showSchemeDetails(schemeId) {
            const modalEl = document.getElementById('schemeDetailsModal');
            let bsModal = bootstrap.Modal.getInstance(modalEl);
            if (!bsModal) bsModal = new bootstrap.Modal(modalEl);

            const loader = document.getElementById('modal-loader');
            const content = document.getElementById('modal-content-area');

            loader.style.display = 'block';
            content.style.display = 'none';
            bsModal.show();

            try {
                const res = await fetch(`/api/schemes/${schemeId}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                const scheme = data.scheme;
                const criteria = scheme.criteria || {};

                // Basic Info
                document.getElementById('modal-category').textContent = scheme.category || 'General';
                document.getElementById('modal-name').textContent = scheme.name;
                document.getElementById('modal-description').textContent = scheme.description;

                // Rich Data Rendering
                formatDetailList(scheme.benefits, 'modal-benefits');
                formatDetailList(scheme.eligibility, 'modal-eligibility');

                // Toggle Sections
                const showEx = formatDetailList(criteria.exclusions, 'modal-exclusions');
                document.getElementById('modal-exclusions-section').style.display = showEx ? 'block' : 'none';

                const showProc = formatDetailList(criteria.applicationProcess, 'modal-process');
                document.getElementById('modal-process-section').style.display = showProc ? 'block' : 'none';

                const showDocs = formatDetailList(criteria.documentsRequired, 'modal-docs');
                document.getElementById('modal-docs-section').style.display = showDocs ? 'block' : 'none';

                document.getElementById('modal-apply-btn').href = scheme.applicationLink || '#';

                loader.style.display = 'none';
                content.style.display = 'block';
            } catch (e) {
                console.error(e);
                alert('Scheme details temporarily unavailable.');
                bsModal.hide();
            }
        }


        // Add hover effect style
        const style = document.createElement('style');
        style.textContent = `
            .scheme-card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
            }
        `;
        document.head.appendChild(style);

        // Initial Load
        // Initial Load
        document.addEventListener('DOMContentLoaded', loadSchemes);
    </script>
    <script src="js/translations.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/chatbot.js"></script>

    <!-- Scheme Details Modal -->
    <div class="modal fade" id="schemeDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0"
                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 1.5rem 2rem;">
                    <div>
                        <h5 class="modal-title fw-bold text-white mb-0">Official Scheme Details</h5>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <span class="badge rounded-pill"
                                style="background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); font-size: 0.65rem;">
                                <i class="fas fa-check-circle me-1"></i>VERIFIED SOURCE
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="modal-loader" class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-3 text-secondary fw-semibold">Loading details... ✨</p>
                    </div>

                    <div id="modal-content-area" style="display: none;">
                        <div class="bg-light p-4 border-bottom mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span id="modal-category" class="badge bg-primary">Category</span>
                            </div>
                            <h4 id="modal-name" class="fw-bold text-dark mb-2"></h4>
                            <p id="modal-description" class="text-secondary mb-0"></p>
                        </div>

                        <div class="px-4 pb-4">
                            <div class="mb-4">
                                <h6 class="fw-bold text-dark"><i class="fas fa-gift text-primary me-2"></i>Benefits</h6>
                                <ul id="modal-benefits" class="mb-0"></ul>
                            </div>

                            <div class="mb-4">
                                <h6 class="fw-bold text-dark"><i
                                        class="fas fa-user-check text-success me-2"></i>Eligibility Criteria</h6>
                                <ul id="modal-eligibility" class="mb-0"></ul>
                            </div>

                            <div id="modal-exclusions-section" class="mb-4" style="display:none;">
                                <h6 class="text-danger fw-bold"><i class="fas fa-ban me-2"></i>Important Exclusions</h6>
                                <ul id="modal-exclusions" class="text-danger-emphasis mb-0"></ul>
                            </div>

                            <div id="modal-process-section" class="mb-4" style="display:none;">
                                <h6 class="text-info fw-bold"><i class="fas fa-route me-2"></i>Application Process</h6>
                                <ul id="modal-process" class="mb-0"></ul>
                            </div>

                            <div id="modal-docs-section" class="mb-4" style="display:none;">
                                <h6 class="text-warning fw-bold"><i class="fas fa-folder-open me-2"></i>Documents
                                    Required</h6>
                                <ul id="modal-docs" class="mb-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top-0 bg-light p-3">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Close</button>
                    <a id="modal-apply-btn" href="#" target="_blank" class="btn btn-primary px-4 fw-bold">
                        Apply on Official Portal <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>

</html>